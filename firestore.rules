
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Allow any authenticated user to read from the top-level users collection
    // This is needed for admin stats (counting users).
    // Individual user data is still protected by the match below.
    match /users/{userId} {
        allow read, write: if request.auth.uid == userId;
    }

    // Allow authenticated users to count all users
    match /users/{document=**} {
        allow read: if request.auth != null;
    }
    
    match /users/{userId}/passengers/{passengerId} {
        allow read, write: if request.auth.uid == userId;
    }

    match /bookings/{bookingId} {
      // Users can create their own bookings.
      allow create: if request.auth.uid == request.resource.data.userId;
      // Users can only read their own bookings.
      allow read: if resource.data.userId == request.auth.uid;
    }
    
    // Allow authenticated users to count all bookings
    match /bookings/{document=**} {
       allow read: if request.auth != null;
    }
    
    match /tatkal_requests/{requestId} {
        allow create: if request.auth.uid == request.resource.data.userId;
        allow read: if resource.data.userId == request.auth.uid;
    }

    match /chatbot_logs/{logId} {
        // Only allow users to create their own logs. No read access.
        allow create: if request.auth.uid == request.resource.data.userId;
    }
    
    match /hotels/{hotelId} {
      // Anyone can read hotel listings.
      allow read: if true;
      // For now, allow anyone to write for the admin panel to work.
      // In production, this should be restricted to admin roles.
      allow write: if true;
    }
  }
}
